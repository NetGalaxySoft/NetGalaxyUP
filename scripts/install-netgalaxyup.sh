#!/bin/bash

# ==========================================================================
#  install-netgalaxyup.sh ‚Äì –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –∏–Ω—Å—Ç–∞–ª–∞—Ü–∏—è –Ω–∞ –ø—Ä–æ–µ–∫—Ç–∞ NetGalaxyUP
# --------------------------------------------------------------------------
#  –í–µ—Ä—Å–∏—è: 1.7
#  –î–∞—Ç–∞: 2025-07-02
#  –ê–≤—Ç–æ—Ä: Ilko Yordanov / NetGalaxy
# ==========================================================================
#
#  –°–∫—Ä–∏–ø—Ç—ä—Ç –∫–ª–æ–Ω–∏—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ NetGalaxyUP –æ—Ç GitHub, –∏–Ω—Å—Ç–∞–ª–∏—Ä–∞ –Ω—É–∂–Ω–∏—Ç–µ
#  –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ –ø–æ–¥–≥–æ—Ç–≤—è —Å—Ä–µ–¥–∞—Ç–∞. –†–∞–±–æ—Ç–∏ –±–µ–∑ –∏–Ω—Ç–µ—Ä–∞–∫—Ü–∏—è.
# ==========================================================================

set -e

echo "=================================================================="
echo " üöÄ NetGalaxyUP ‚Äì –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –∏–Ω—Å—Ç–∞–ª–∞—Ü–∏—è"
echo "=================================================================="

# –û—á–∞–∫–≤–∞–º–µ GitHub —Ç–æ–∫–µ–Ω –∫–∞—Ç–æ –∞—Ä–≥—É–º–µ–Ω—Ç
GITHUB_TOKEN="$1"

if [[ -z "$GITHUB_TOKEN" ]]; then
  echo "‚ùå –õ–∏–ø—Å–≤–∞ GitHub —Ç–æ–∫–µ–Ω –∫–∞—Ç–æ –∞—Ä–≥—É–º–µ–Ω—Ç."
  echo "   –ò–∑–ø–æ–ª–∑–≤–∞–π —Å–ª–µ–¥–Ω–∏—è —Å–∏–Ω—Ç–∞–∫—Å–∏—Å:"
  echo
  echo "   bash install-netgalaxyup.sh <GITHUB_TOKEN>"
  echo
  exit 1
fi

# –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è ~/projects –∞–∫–æ –Ω–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞
mkdir -p ~/projects
cd ~/projects || exit 1

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –ø—Ä–æ–µ–∫—Ç—ä—Ç –≤–µ—á–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞
if [[ -d "NetGalaxyUP" ]]; then
  echo "‚úÖ –ü—Ä–æ–µ–∫—Ç—ä—Ç NetGalaxyUP –≤–µ—á–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞. –ü—Ä–æ–ø—É—Å–∫–∞–Ω–µ –Ω–∞ –∫–ª–æ–Ω–∏—Ä–∞–Ω–µ—Ç–æ."
else
  echo "‚è≥ –ö–ª–æ–Ω–∏—Ä–∞–Ω–µ –Ω–∞ –ø—Ä–æ–µ–∫—Ç–∞ –æ—Ç GitHub..."

  ASKPASS_SCRIPT="$(mktemp)"
  echo "#!/bin/bash" > "$ASKPASS_SCRIPT"
  echo "echo $GITHUB_TOKEN" >> "$ASKPASS_SCRIPT"
  chmod +x "$ASKPASS_SCRIPT"

  export GIT_ASKPASS="$ASKPASS_SCRIPT"
  export GIT_USERNAME="NetGalaxySoft"
  GIT_TERMINAL_PROMPT=0 git clone https://github.com/NetGalaxySoft/NetGalaxyUP.git

  rm -f "$ASKPASS_SCRIPT"
fi

cd NetGalaxyUP || exit 1

# –ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–µ –Ω–∞ backend –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "=================================================================="
echo " üêç –ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–µ –Ω–∞ Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (backend)..."
echo "=================================================================="
cd backend || exit 1
python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt
cd ..

# –ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–µ –Ω–∞ frontend –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "=================================================================="
echo " üíª –ò–Ω—Å—Ç–∞–ª–∏—Ä–∞–Ω–µ –Ω–∞ Node –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (frontend)..."
echo "=================================================================="
cd frontend || exit 1
npm install
cd ..

# –ò–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ –ø—É–±–ª–∏—á–Ω–∏—è IP –∞–¥—Ä–µ—Å
SERVER_IP=$(hostname -I | awk '{print $1}')

# –°—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ backend —Å—ä—Ä–≤—ä—Ä–∞ (Uvicorn)
echo "=================================================================="
echo " üîÑ –°—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ backend —Å—ä—Ä–≤—ä—Ä–∞ (Uvicorn)..."
echo "=================================================================="
cd backend || exit 1
source venv/bin/activate
nohup uvicorn src.app:app --host 0.0.0.0 --port 8000 --reload > ../backend.log 2>&1 &
deactivate
cd ..
echo "‚úÖ Backend —Å—ä—Ä–≤—ä—Ä—ä—Ç —Ä–∞–±–æ—Ç–∏ –Ω–∞: http://$SERVER_IP:8000"

# –°—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ frontend —Å—ä—Ä–≤—ä—Ä–∞ (Vite)
echo "=================================================================="
echo " üîÑ –°—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ frontend —Å—ä—Ä–≤—ä—Ä–∞ (Vite)..."
echo "=================================================================="
cd frontend || exit 1
nohup npm run dev -- --host 0.0.0.0 --port 5173 > ../frontend.log 2>&1 &
cd ..
echo "‚úÖ Frontend —Å—ä—Ä–≤—ä—Ä—ä—Ç —Ä–∞–±–æ—Ç–∏ –Ω–∞: http://$SERVER_IP:5173"

# –§–∏–Ω–∞–ª–Ω–æ —Å—ä–æ–±—â–µ–Ω–∏–µ
echo "=================================================================="
echo " ‚úÖ –ò–Ω—Å—Ç–∞–ª–∞—Ü–∏—è—Ç–∞ –Ω–∞ NetGalaxyUP –µ –∑–∞–≤—ä—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ."
echo "=================================================================="
